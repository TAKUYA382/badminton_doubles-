<div class="page">
  <!-- ===== „Éò„ÉÉ„ÉÄ„ÉºÔºà„Ç§„Éô„É≥„Éà„Çø„Ç§„Éà„É´„Å®„Çπ„ÉÜ„Éº„Çø„ÇπÔºâ ===== -->
  <div class="card" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:16px;">
    <div>
      <h1 class="page-title"><%= @event.title.presence || "Ôºà„Çø„Ç§„Éà„É´Êú™Ë®≠ÂÆöÔºâ" %></h1>
      <p class="page-sub">Êó•‰ªòÔºö<%= @event.date %> / „Ç≥„Éº„ÉàÊï∞Ôºö<%= @event.court_count %></p>
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <% if @event.status_draft? %>
        <%= button_to "ÂÖ¨Èñã„Åô„Çã", publish_admin_event_path(@event), method: :patch, class: "btn btn-primary" %>
      <% else %>
        <span style="color:green;margin-right:8px;">„Åì„ÅÆ„Ç§„Éô„É≥„Éà„ÅØÂÖ¨Èñã‰∏≠„Åß„Åô ‚úÖ</span>
        <%= button_to "ÈùûÂÖ¨Èñã„Å´Êàª„Åô", unpublish_admin_event_path(@event), method: :patch,
              data: { turbo_confirm: "Êú¨ÂΩì„Å´ÈùûÂÖ¨Èñã„Å´„Åó„Åæ„Åô„ÅãÔºü" }, class: "btn btn-outline" %>
      <% end %>
      <%= link_to "„Ç§„Éô„É≥„Éà„ÇíÁ∑®ÈõÜ", edit_admin_event_path(@event), class: "btn btn-outline" %>
      <%= button_to "„Ç§„Éô„É≥„Éà„ÇíÂâäÈô§", admin_event_path(@event),
            method: :delete,
            data: { turbo_confirm: "ÂâäÈô§„Åô„Çã„Å®ÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü" },
            class: "btn btn-danger" %>
    </div>
  </div>

  <!-- ===== Ëá™ÂãïÁ∑®Êàê„Éï„Ç©„Éº„É† + ÂèÇÂä†ËÄÖÈñ¢ÈÄ£„É™„É≥„ÇØ ===== -->
  <div class="card" style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;margin-bottom:16px;">
    <%= form_with url: auto_schedule_admin_event_path(@event), method: :post, local: true do %>
      <label>‰ΩïÂõûÊà¶ÔºàÁî∑Â•≥Âà•Ôºâ</label>
      <div style="display:flex;gap:6px;align-items:center;">
        <%= number_field_tag :rounds, params[:rounds] || 2, min: 1, style: "width:80px;" %>
        <%= hidden_field_tag :mode, "split" %>
        <%= submit_tag "Áî∑Â•≥Âà•„Åß‰ΩúÊàê", class: "btn btn-primary" %>
      </div>
    <% end %>

    <%= form_with url: auto_schedule_admin_event_path(@event), method: :post, local: true do %>
      <label>‰ΩïÂõûÊà¶ÔºàMIXÔºâ</label>
      <div style="display:flex;gap:6px;align-items:center;">
        <%= number_field_tag :rounds, params[:rounds] || 2, min: 1, style: "width:80px;" %>
        <%= hidden_field_tag :mode, "mixed" %>
        <%= submit_tag "MIX„Åß‰ΩúÊàê", class: "btn btn-outline" %>
      </div>
    <% end %>

    <%= link_to "ÂèÇÂä†ËÄÖÁÆ°ÁêÜ", admin_event_attendances_path(@event), class: "btn btn-outline", style: "margin-left:auto;" %>
    <%= link_to "ÂèÇÂä†ËÄÖ„Çí„Éö„Éº„Çπ„ÉàÂÖ•Âäõ", paste_participants_admin_event_path(@event), class: "btn btn-outline" %>
  </div>

  <% if flash[:alert].present? %>
    <div class="card" style="border:1px solid #fca5a5;background:#fee2e2;color:#991b1b;margin-bottom:12px;">
      <%= flash[:alert] %>
    </div>
  <% end %>
  <% if flash[:notice].present? %>
    <div class="card" style="border:1px solid #86efac;background:#dcfce7;color:#14532d;margin-bottom:12px;">
      <%= flash[:notice] %>
    </div>
  <% end %>

  <div class="layout-2col">
    <!-- Â∑¶ÔºöÂèÇÂä†ÂõûÊï∞ + „Éâ„É©„ÉÉ„Ç∞ÂÖÉ -->
    <aside class="col-left">
      <h2>ÂèÇÂä†ÂõûÊï∞Ôºà„Åì„ÅÆ„Ç§„Éô„É≥„ÉàÔºâ</h2>
      <div class="table-wrap">
        <table class="table" style="min-width:320px;">
          <thead>
            <tr>
              <th>ÂêçÂâç</th><th>Â≠¶Âπ¥</th><th>ÊÄßÂà•</th><th>„É¨„Éô„É´</th><th>ÂõûÊï∞</th>
            </tr>
          </thead>
          <tbody>
            <% @participations.each do |mem, cnt| %>
              <tr>
                <td><%= mem.name %></td>
                <td><%= mem.grade_label %></td>
                <td><%= mem.gender_label %></td>
                <td><%= mem.skill_label %></td>
                <td><%= cnt %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      <p class="muted" style="margin-top:6px;">‚Äª ÂõûÊï∞„ÅØÂØæÊà¶‰ΩúÊàêÂæå„Å´Êõ¥Êñ∞„Åï„Çå„Åæ„Åô„ÄÇ</p>

      <!-- ‚ñº „Éâ„É©„ÉÉ„Ç∞ÂÖÉÔºöÁî∑Â•≥√ó„É¨„Éô„É´Â∏Ø„ÅßË°®Á§∫ -->
      <div class="card" style="margin-top:12px;">
        <div class="card-header">„É°„É≥„Éê„ÉºÔºà„Éâ„É©„ÉÉ„Ç∞„ÅßÂ∑Æ„ÅóÊõø„ÅàÔºâ</div>

        <% level_order = %w[A_plus A A_minus B_plus B B_minus C_plus C C_minus D_plus D] %>
        <% genders = { "Áî∑Â≠ê" => :male, "Â•≥Â≠ê" => :female } %>

        <% genders.each do |gender_label, gender_sym| %>
          <% members_by_gender = (@drag_members || []).select { |m| m.gender.to_sym == gender_sym } %>
          <% next if members_by_gender.blank? %>

          <div class="chip-gender-block">
            <div class="chip-gender-title"><%= gender_label %></div>

            <% level_order.each do |lv| %>
              <% group = members_by_gender.select { |m| m.skill_level == lv } %>
              <% next if group.blank? %>

              <div class="chip-section">
                <div class="chip-section-title">
                  <span class="lvl-badge lvl-<%= lv %>"><%= I18n.t("enums.member.skill_level.#{lv}") %></span>
                  <span class="muted" style="margin-left:6px;">(<%= group.size %>‰∫∫)</span>
                </div>

                <div class="chip-grid">
                  <% group.sort_by! { |m| [m.name_kana.presence || m.name, m.id] } %>
                  <% group.each do |mem| %>
                    <span class="member-chip"
                          draggable="true"
                          data-member-id="<%= mem.id %>"
                          title="<%= [mem.name_kana.presence, mem.grade_label, mem.gender_label].compact.join(' / ') %>">
                      <span class="chip-name"><%= mem.name %></span>
                      <span class="chip-sub"><%= mem.grade_label %></span>
                    </span>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    </aside>

    <!-- Âè≥ÔºöÂØæÊà¶Ë°®ÔºàÁ∑®ÈõÜÂèØÔºâ -->
    <section class="col-right">
      <h2>ÂØæÊà¶Ë°®</h2>
      <% @event.rounds.order(:index).each do |r| %>
        <% r.matches.order(:court_number).each do |m| %>
          <% gs = [m.pair1_member1&.gender, m.pair1_member2&.gender, m.pair2_member1&.gender, m.pair2_member2&.gender].compact %>
          <% label = gs.present? && gs.all?("male") ? "Áî∑Â≠ê" : (gs.present? && gs.all?("female") ? "Â•≥Â≠ê" : "MIX") %>

          <div class="card" style="margin-bottom:12px;">
            <h3 style="margin-bottom:6px;">
              <%= r.index %> ÂõûÊà¶„ÄÄ<%= m.court_number %>„Ç≥„Éº„Éà„ÄÄ
              <span class="muted"><%= label %></span>
            </h3>

            <table class="table" style="min-width:780px;">
              <thead>
                <tr>
                  <th style="width:50%;">„Éö„Ç¢1ÔºàÁ∑®ÈõÜÂèØÔºâ</th>
                  <th style="width:50%;">„Éö„Ç¢2ÔºàÁ∑®ÈõÜÂèØÔºâ</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <!-- „Éö„Ç¢1 -->
                  <td>
                    <% ["pair1_member1", "pair1_member2"].each do |slot_key| %>
                      <% mem = m.send(slot_key) %>
                      <div class="slot-editor drop-target"
                           data-drop-slot="<%= slot_key %>"
                           data-match-id="<%= m.id %>"
                           data-update-url="<%= update_slot_admin_event_path(@event) %>">
                        <div class="info">
                          <div><strong><%= mem&.name || "ÔºàÊú™Ë®≠ÂÆöÔºâ" %></strong>
                            <% if mem %>Ôºà<%= mem.grade_label %>„Éª<%= mem.gender_label %>„Éª<%= mem.skill_label %>Ôºâ<% end %>
                          </div>
                        </div>

                        <!-- „ÇØ„É™„Ç¢ -->
                        <%= form_with url: update_slot_admin_event_path(@event), method: :patch, local: true do %>
                          <%= hidden_field_tag :match_id, m.id %>
                          <%= hidden_field_tag :slot_key, slot_key %>
                          <%= hidden_field_tag :clear, "1" %>
                          <button class="btn btn-outline btn-compact">√ó</button>
                        <% end %>

                        <!-- Â∑Æ„ÅóÊõø„Åà„Çª„É¨„ÇØ„Éà -->
                        <%= form_with url: update_slot_admin_event_path(@event), method: :patch, local: true do %>
                          <%= hidden_field_tag :match_id, m.id %>
                          <%= hidden_field_tag :slot_key, slot_key %>
                          <%= select_tag :member_id,
                                options_from_collection_for_select(
                                  @drag_members, :id,
                                  ->(mm){ "#{mm.name}Ôºà#{mm.grade_label}„Éª#{mm.gender_label}„Éª#{mm.skill_label}Ôºâ" }
                                ),
                                prompt: "ÈÅ∏Êäû„Åó„Å¶Â∑Æ„ÅóÊõø„Åà", class: "select-compact" %>
                          <button class="btn btn-primary btn-compact">üîÅ</button>
                        <% end %>
                      </div>
                    <% end %>
                  </td>

                  <!-- „Éö„Ç¢2 -->
                  <td>
                    <% ["pair2_member1", "pair2_member2"].each do |slot_key| %>
                      <% mem = m.send(slot_key) %>
                      <div class="slot-editor drop-target"
                           data-drop-slot="<%= slot_key %>"
                           data-match-id="<%= m.id %>"
                           data-update-url="<%= update_slot_admin_event_path(@event) %>">
                        <div class="info">
                          <div><strong><%= mem&.name || "ÔºàÊú™Ë®≠ÂÆöÔºâ" %></strong>
                            <% if mem %>Ôºà<%= mem.grade_label %>„Éª<%= mem.gender_label %>„Éª<%= mem.skill_label %>Ôºâ<% end %>
                          </div>
                        </div>

                        <!-- „ÇØ„É™„Ç¢ -->
                        <%= form_with url: update_slot_admin_event_path(@event), method: :patch, local: true do %>
                          <%= hidden_field_tag :match_id, m.id %>
                          <%= hidden_field_tag :slot_key, slot_key %>
                          <%= hidden_field_tag :clear, "1" %>
                          <button class="btn btn-outline btn-compact">√ó</button>
                        <% end %>

                        <!-- Â∑Æ„ÅóÊõø„Åà„Çª„É¨„ÇØ„Éà -->
                        <%= form_with url: update_slot_admin_event_path(@event), method: :patch, local: true do %>
                          <%= hidden_field_tag :match_id, m.id %>
                          <%= hidden_field_tag :slot_key, slot_key %>
                          <%= select_tag :member_id,
                                options_from_collection_for_select(
                                  @drag_members, :id,
                                  ->(mm){ "#{mm.name}Ôºà#{mm.grade_label}„Éª#{mm.gender_label}„Éª#{mm.skill_label}Ôºâ" }
                                ),
                                prompt: "ÈÅ∏Êäû„Åó„Å¶Â∑Æ„ÅóÊõø„Åà", class: "select-compact" %>
                          <button class="btn btn-primary btn-compact">üîÅ</button>
                        <% end %>
                      </div>
                    <% end %>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        <% end %>
      <% end %>
    </section>
  </div>
</div>
